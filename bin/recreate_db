#!/usr/bin/env bash

function error_handler() {
  >&2 echo "Exited with BAD EXIT CODE '${2}' in ${0} script at line: ${1}."
  exit "$2"
}
trap 'error_handler ${LINENO} $?' ERR
set -o errtrace -o errexit -o nounset -o pipefail

export FLASK_SESSION_SECRET_KEY="this_is_recreate_db_secret_key"

tasks=""
if [[ "${1:-}" == "clean" ]]; then
  if [[ "${2:-}" == "rmall" ]]; then
    tasks="$tasks init migrate"
    rm -rf migrations/
  fi

  rm -f ./src/spiffworkflow_backend/db*.sqlite3
  mysql -uroot -e "DROP DATABASE IF EXISTS spiffworkflow_backend_development"
  mysql -uroot -e "CREATE DATABASE spiffworkflow_backend_development"
  mysql -uroot -e "DROP DATABASE IF EXISTS spiffworkflow_backend_testing"
  mysql -uroot -e "CREATE DATABASE spiffworkflow_backend_testing"
fi
tasks="$tasks upgrade"

for task in $tasks ; do
  FLASK_ENV=development FLASK_APP=src/spiffworkflow_backend poetry run flask db "$task"
done

FLASK_ENV=testing FLASK_APP=src/spiffworkflow_backend poetry run flask db upgrade
